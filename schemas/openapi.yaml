openapi: 3.0.3
info:
  title: TheOpenMusicBox API
  description: |
    Complete API contract definitions for TheOpenMusicBox - A Raspberry Pi-based music player system.

    All API responses follow the UnifiedResponseService format with standardized envelopes.
    This specification is the source of truth for all client implementations (Web, Flutter, C++).
  version: 2.0.0
  contact:
    name: TheOpenMusicBox
    url: https://github.com/theopenmusicbox/tomb-rpi
  license:
    name: MIT

servers:
  - url: http://localhost:8000
    description: Local development server
  - url: http://{host}:8000
    description: Custom deployment
    variables:
      host:
        default: localhost
        description: Raspberry Pi hostname or IP address

tags:
  - name: Health
    description: Health check endpoints
  - name: Player
    description: Audio player control endpoints
  - name: Playlists
    description: Playlist management endpoints
  - name: NFC
    description: NFC tag association endpoints
  - name: System
    description: System information and control
  - name: YouTube
    description: YouTube download functionality
  - name: Uploads
    description: File upload management

components:
  schemas:
    UnifiedResponse:
      type: object
      description: Standardized response wrapper used by all API endpoints
      required:
        - status
        - message
        - timestamp
      properties:
        status:
          type: string
          enum: [success, error]
        message:
          type: string
        data:
          oneOf:
            - type: object
            - type: array
              items: {}
            - type: "null"
        client_op_id:
          type: string
          nullable: true
          description: Client operation ID for operation tracking
        server_seq:
          type: number
          nullable: true
          description: Server sequence number for state synchronization
        timestamp:
          type: number
          description: Unix timestamp in seconds
        request_id:
          type: string
          nullable: true
        error_type:
          type: string
          nullable: true
          enum:
            - validation_error
            - not_found
            - rate_limit_exceeded
            - service_unavailable
            - internal_error
            - conflict
            - bad_request
        details:
          type: object
          nullable: true
          additionalProperties: true

    Track:
      type: object
      required:
        - id
        - number
        - title
        - filename
      properties:
        id:
          type: string
          description: "Unique track identifier in format: {playlist_id}_{track_number}"
        number:
          type: integer
          description: Track number in playlist
        title:
          type: string
        filename:
          type: string
        file_path:
          type: string
        duration:
          type: integer
          nullable: true
          deprecated: true
          description: |
            DEPRECATED: Use duration_ms instead for millisecond precision.
            Duration in seconds. Will be removed in v4.0.0.
        duration_ms:
          type: integer
          nullable: true
          description: Duration in milliseconds (preferred over duration)
        artist:
          type: string
          nullable: true
        album:
          type: string
          nullable: true
        file_size:
          type: integer
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    PlaylistSummary:
      type: object
      required:
        - id
        - title
        - track_count
      properties:
        id:
          type: string
        title:
          type: string
        track_count:
          type: integer
        nfc_tag_id:
          type: string
          nullable: true
        server_seq:
          type: number
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    PlaylistDetailed:
      type: object
      required:
        - id
        - title
        - tracks
      properties:
        id:
          type: string
        title:
          type: string
        description:
          type: string
        tracks:
          type: array
          items:
            $ref: '#/components/schemas/Track'
        nfc_tag_id:
          type: string
          nullable: true
        server_seq:
          type: number
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        total_duration_ms:
          type: integer

    PlayerState:
      type: object
      required:
        - is_playing
        - position_ms
        - can_prev
        - can_next
        - server_seq
      properties:
        is_playing:
          type: boolean
        active_playlist_id:
          type: string
          nullable: true
        active_playlist_title:
          type: string
          nullable: true
        active_track_id:
          type: string
          nullable: true
        active_track:
          nullable: true
          allOf:
            - $ref: '#/components/schemas/Track'
        active_track_number:
          type: integer
          nullable: true
          description: Track number in playlist (lightweight alternative to full active_track)
        active_track_title:
          type: string
          nullable: true
          description: Track title (lightweight alternative to full active_track)
        track_index:
          type: integer
          nullable: true
          description: 0-based track index in playlist
        track_count:
          type: integer
          nullable: true
          description: Total number of tracks in playlist
        position_ms:
          type: integer
          description: Current playback position in milliseconds
        duration_ms:
          type: integer
          nullable: true
          description: Track duration in milliseconds
        can_prev:
          type: boolean
        can_next:
          type: boolean
        volume:
          type: integer
          nullable: true
          minimum: 0
          maximum: 100
        server_seq:
          type: number

    # NFCAssociation - Base schema with discriminator for playlist OR webhook
    NFCAssociationBase:
      type: object
      required:
        - tag_id
        - association_type
        - created_at
      properties:
        tag_id:
          type: string
          description: "NFC tag unique identifier (UID as hex string)"
          example: "04:A3:2C:1A:5D:6E:80"
        association_type:
          type: string
          enum: [playlist, webhook]
          description: "Type of association"
        created_at:
          type: string
          format: date-time
          description: "ISO 8601 timestamp of association creation"
      discriminator:
        propertyName: association_type
        mapping:
          playlist: '#/components/schemas/NFCPlaylistAssociation'
          webhook: '#/components/schemas/NFCWebhookAssociation'

    NFCPlaylistAssociation:
      allOf:
        - $ref: '#/components/schemas/NFCAssociationBase'
        - type: object
          required:
            - playlist_id
            - playlist_title
          properties:
            playlist_id:
              type: string
              description: "Associated playlist unique identifier"
            playlist_title:
              type: string
              description: "Playlist title (cached for display)"

    NFCWebhookAssociation:
      allOf:
        - $ref: '#/components/schemas/NFCAssociationBase'
        - type: object
          required:
            - webhook_url
          properties:
            webhook_url:
              type: string
              format: uri
              description: "HTTP(S) URL to trigger"
              example: "https://api.example.com/webhook"
            webhook_method:
              type: string
              enum: [GET, POST, PUT]
              default: POST
              description: "HTTP method to use"
            webhook_headers:
              type: object
              additionalProperties:
                type: string
              description: "Custom HTTP headers"
              example:
                Authorization: "Bearer token123"
                X-Device-ID: "{{device_id}}"
            webhook_body:
              type: string
              description: "Request body template (supports variable substitution)"
              example: '{"tag_id": "{{tag_id}}", "timestamp": "{{timestamp}}"}'
            webhook_timeout_ms:
              type: integer
              minimum: 1000
              maximum: 30000
              default: 5000
              description: "Request timeout in milliseconds"
            last_triggered_at:
              type: string
              format: date-time
              nullable: true
              description: "ISO 8601 timestamp of last trigger"
            trigger_count:
              type: integer
              minimum: 0
              default: 0
              description: "Number of times this webhook has been triggered"

    # NFCAssociation - Union type for backward compatibility
    NFCAssociation:
      oneOf:
        - $ref: '#/components/schemas/NFCPlaylistAssociation'
        - $ref: '#/components/schemas/NFCWebhookAssociation'
      discriminator:
        propertyName: association_type

    SystemInfo:
      type: object
      required:
        - platform
        - platform_release
        - platform_version
        - architecture
        - hostname
        - processor
        - server_seq
      properties:
        platform:
          type: string
        platform_release:
          type: string
        platform_version:
          type: string
        architecture:
          type: string
        hostname:
          type: string
        processor:
          type: string
        memory_total:
          type: integer
        memory_available:
          type: integer
        memory_percent:
          type: number
        server_seq:
          type: number
          description: Server sequence number for state synchronization

    HealthStatus:
      type: object
      required:
        - status
        - services
        - timestamp
        - server_seq
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        services:
          type: object
          required:
            - api
            - audio
            - nfc
            - gpio
            - led_hat
            - websocket
          properties:
            api:
              type: boolean
            audio:
              type: boolean
            nfc:
              type: boolean
            gpio:
              type: boolean
            led_hat:
              type: boolean
            websocket:
              type: boolean
        timestamp:
          type: number
        server_seq:
          type: number
          description: Server sequence number for state synchronization

    UploadSession:
      type: object
      required:
        - session_id
        - playlist_id
        - filename
        - file_size
        - chunk_size
        - total_chunks
      properties:
        session_id:
          type: string
        playlist_id:
          type: string
        filename:
          type: string
        file_size:
          type: integer
          description: Total file size in bytes
        chunk_size:
          type: integer
          description: Size of each chunk in bytes
        total_chunks:
          type: integer
          description: Total number of chunks
        file_hash:
          type: string
          nullable: true
          description: Optional file hash for verification
        created_at:
          type: string
          format: date-time

    UploadSessionStatus:
      type: object
      required:
        - session_id
        - filename
        - file_size
        - chunks_uploaded
        - chunks_total
        - progress_percent
        - status
      properties:
        session_id:
          type: string
        filename:
          type: string
        file_size:
          type: integer
        chunks_uploaded:
          type: integer
        chunks_total:
          type: integer
        progress_percent:
          type: number
          minimum: 0
          maximum: 100
        playlist_id:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
          nullable: true
        status:
          type: string
          enum: [pending, uploading, completed, error]

    ChunkUploadResult:
      type: object
      required:
        - chunk_index
        - received
        - total_chunks
      properties:
        chunk_index:
          type: integer
        received:
          type: boolean
        total_chunks:
          type: integer
        progress_percent:
          type: number

    UploadFinalizeResult:
      type: object
      required:
        - status
        - message
      properties:
        status:
          type: string
          enum: [success, error]
        message:
          type: string
        track:
          nullable: true
          allOf:
            - $ref: '#/components/schemas/Track'

    YouTubeSearchResult:
      type: object
      required:
        - video_id
        - title
        - duration
      properties:
        video_id:
          type: string
        title:
          type: string
        duration:
          type: integer
          description: Duration in seconds
        thumbnail:
          type: string
          nullable: true
        channel:
          type: string
          nullable: true

    YouTubeDownloadStatus:
      type: object
      required:
        - task_id
        - status
      properties:
        task_id:
          type: string
        status:
          type: string
          enum: [pending, downloading, processing, completed, failed]
        progress:
          type: number
          minimum: 0
          maximum: 100
          nullable: true
        error:
          type: string
          nullable: true
        track:
          nullable: true
          allOf:
            - $ref: '#/components/schemas/Track'

paths:
  /api/health:
    get:
      tags: [Health]
      summary: Health check endpoint
      operationId: getHealth
      responses:
        '200':
          description: Health status
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/HealthStatus'

  /api/player/play:
    post:
      tags: [Player]
      summary: Start/resume playback
      operationId: playerPlay
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                client_op_id:
                  type: string
      responses:
        '200':
          description: Player state after play command
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/PlayerState'

  /api/player/pause:
    post:
      tags: [Player]
      summary: Pause playback
      operationId: playerPause
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                client_op_id:
                  type: string
      responses:
        '200':
          description: Player state after pause command
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/PlayerState'

  /api/player/stop:
    post:
      tags: [Player]
      summary: Stop playback
      operationId: playerStop
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                client_op_id:
                  type: string
      responses:
        '200':
          description: Player state after stop command
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/PlayerState'

  /api/player/next:
    post:
      tags: [Player]
      summary: Skip to next track
      operationId: playerNext
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                client_op_id:
                  type: string
      responses:
        '200':
          description: Player state after next command
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/PlayerState'

  /api/player/previous:
    post:
      tags: [Player]
      summary: Skip to previous track
      operationId: playerPrevious
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                client_op_id:
                  type: string
      responses:
        '200':
          description: Player state after previous command
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/PlayerState'

  /api/player/toggle:
    post:
      tags: [Player]
      summary: Toggle play/pause
      operationId: playerToggle
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                client_op_id:
                  type: string
      responses:
        '200':
          description: Player state after toggle command
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/PlayerState'

  /api/player/status:
    get:
      tags: [Player]
      summary: Get current player status
      operationId: getPlayerStatus
      responses:
        '200':
          description: Current player state
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/PlayerState'

  /api/player/seek:
    post:
      tags: [Player]
      summary: Seek to position in current track
      operationId: playerSeek
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - position_ms
              properties:
                position_ms:
                  type: integer
                  minimum: 0
                  maximum: 86400000
                  description: Position in milliseconds
                client_op_id:
                  type: string
      responses:
        '200':
          description: Player state after seek
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/PlayerState'

  /api/player/volume:
    post:
      tags: [Player]
      summary: Set volume level
      operationId: setVolume
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - volume
              properties:
                volume:
                  type: integer
                  minimum: 0
                  maximum: 100
                client_op_id:
                  type: string
      responses:
        '200':
          description: Player state after volume change
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/PlayerState'

  /api/playlists:
    get:
      tags: [Playlists]
      summary: List all playlists with pagination
      operationId: listPlaylists
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
      responses:
        '200':
          description: Paginated list of playlists
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - playlists
                          - page
                          - limit
                          - total
                          - total_pages
                        properties:
                          playlists:
                            type: array
                            items:
                              $ref: '#/components/schemas/PlaylistSummary'
                          page:
                            type: integer
                          limit:
                            type: integer
                          total:
                            type: integer
                          total_pages:
                            type: integer

    post:
      tags: [Playlists]
      summary: Create new playlist
      operationId: createPlaylist
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
              properties:
                title:
                  type: string
                  minLength: 1
                description:
                  type: string
                client_op_id:
                  type: string
      responses:
        '201':
          description: Created playlist
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/PlaylistDetailed'

  /api/playlists/{playlist_id}:
    get:
      tags: [Playlists]
      summary: Get specific playlist
      operationId: getPlaylist
      parameters:
        - name: playlist_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Playlist details
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/PlaylistDetailed'

    put:
      tags: [Playlists]
      summary: Update playlist
      operationId: updatePlaylist
      parameters:
        - name: playlist_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                description:
                  type: string
                client_op_id:
                  type: string
      responses:
        '200':
          description: Update confirmation
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          client_op_id:
                            type: string

    delete:
      tags: [Playlists]
      summary: Delete playlist
      operationId: deletePlaylist
      parameters:
        - name: playlist_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                client_op_id:
                  type: string
      responses:
        '204':
          description: Playlist deleted successfully

  /api/playlists/{playlist_id}/start:
    post:
      tags: [Playlists]
      summary: Start playlist playback
      operationId: startPlaylist
      parameters:
        - name: playlist_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                client_op_id:
                  type: string
      responses:
        '200':
          description: Playlist started
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          playlist_id:
                            type: string
                          started:
                            type: boolean

  /api/playlists/{playlist_id}/reorder:
    post:
      tags: [Playlists]
      summary: Reorder tracks in playlist
      operationId: reorderPlaylist
      parameters:
        - name: playlist_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - track_ids
              properties:
                track_ids:
                  type: array
                  items:
                    type: string
                  description: Ordered list of track IDs
                client_op_id:
                  type: string
      responses:
        '200':
          description: Playlist reordered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnifiedResponse'

  /api/playlists/{playlist_id}/tracks:
    delete:
      tags: [Playlists]
      summary: Remove tracks from playlist
      operationId: removeTracksFromPlaylist
      parameters:
        - name: playlist_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - track_ids
              properties:
                track_ids:
                  type: array
                  items:
                    type: string
                  description: List of track IDs to remove
                client_op_id:
                  type: string
      responses:
        '200':
          description: Tracks removed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnifiedResponse'

  /api/playlists/move-track:
    post:
      tags: [Playlists]
      summary: Move track between playlists
      operationId: moveTrack
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - source_playlist_id
                - target_playlist_id
                - track_id
              properties:
                source_playlist_id:
                  type: string
                target_playlist_id:
                  type: string
                track_id:
                  type: string
                target_position:
                  type: integer
                  nullable: true
                client_op_id:
                  type: string
      responses:
        '200':
          description: Track moved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnifiedResponse'

  /api/playlists/sync:
    post:
      tags: [Playlists]
      summary: Sync playlist state
      operationId: syncPlaylists
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                last_sync_seq:
                  type: number
                  description: Last known server sequence number
                client_op_id:
                  type: string
      responses:
        '200':
          description: Playlist state synchronized
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          playlists:
                            type: array
                            items:
                              $ref: '#/components/schemas/PlaylistDetailed'
                          server_seq:
                            type: number

  /api/playlists/{playlist_id}/uploads/session:
    post:
      tags: [Uploads, Playlists]
      summary: Initialize chunked upload session
      operationId: initUploadSession
      parameters:
        - name: playlist_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - filename
                - file_size
              properties:
                filename:
                  type: string
                file_size:
                  type: integer
                  description: Total file size in bytes
                chunk_size:
                  type: integer
                  default: 32768
                  maximum: 32768
                  description: Chunk size in bytes (ESP32 supports max 32KB)
                file_hash:
                  type: string
                  nullable: true
      responses:
        '201':
          description: Upload session initialized
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/UploadSession'

  /api/playlists/{playlist_id}/uploads/{session_id}/chunks/{chunk_index}:
    put:
      tags: [Uploads, Playlists]
      summary: Upload a file chunk
      operationId: uploadChunk
      parameters:
        - name: playlist_id
          in: path
          required: true
          schema:
            type: string
        - name: session_id
          in: path
          required: true
          schema:
            type: string
        - name: chunk_index
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        '200':
          description: Chunk uploaded successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/ChunkUploadResult'

  /api/playlists/{playlist_id}/uploads/{session_id}/finalize:
    post:
      tags: [Uploads, Playlists]
      summary: Finalize upload and add track to playlist
      operationId: finalizeUpload
      parameters:
        - name: playlist_id
          in: path
          required: true
          schema:
            type: string
        - name: session_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                file_hash:
                  type: string
                  nullable: true
                metadata_override:
                  type: object
                  nullable: true
                client_op_id:
                  type: string
      responses:
        '200':
          description: Upload finalized and track added
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/UploadFinalizeResult'

  /api/playlists/{playlist_id}/uploads/{session_id}:
    get:
      tags: [Uploads, Playlists]
      summary: Get upload session status
      operationId: getUploadStatus
      parameters:
        - name: playlist_id
          in: path
          required: true
          schema:
            type: string
        - name: session_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Upload session status
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/UploadSessionStatus'

  /api/uploads/sessions:
    get:
      tags: [Uploads]
      summary: List all upload sessions
      operationId: listUploadSessions
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, uploading, completed, error]
          description: Filter by upload status
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          description: Maximum sessions to return
      responses:
        '200':
          description: List of upload sessions
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          sessions:
                            type: array
                            items:
                              $ref: '#/components/schemas/UploadSessionStatus'

  /api/uploads/sessions/{session_id}:
    delete:
      tags: [Uploads]
      summary: Delete upload session
      operationId: deleteUploadSession
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Upload session deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnifiedResponse'

  /api/uploads/cleanup:
    post:
      tags: [Uploads]
      summary: Cleanup stale upload sessions
      operationId: cleanupStaleSessions
      parameters:
        - name: max_age_hours
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 168
            default: 24
          description: Maximum age in hours for cleanup
      responses:
        '200':
          description: Stale sessions cleaned up
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          cleaned_sessions:
                            type: array
                            items:
                              type: object
                              properties:
                                session_id:
                                  type: string
                                filename:
                                  type: string
                                age_hours:
                                  type: number

  /api/nfc/associate:
    post:
      tags: [NFC]
      summary: Associate NFC tag with playlist or webhook
      description: |
        Create an association between an NFC tag and either a playlist or a webhook.

        **Playlist Association:**
        - Requires `playlist_id` field
        - Tag will trigger playlist playback when scanned

        **Webhook Association:**
        - Requires `webhook_url` field
        - Tag will trigger HTTP webhook when scanned
        - Supports variable substitution in URL, headers, and body:
          - `{{tag_id}}` - NFC tag identifier
          - `{{timestamp}}` - ISO 8601 UTC timestamp
          - `{{device_id}}` - Device unique identifier
          - `{{trigger_count}}` - Number of times triggered
      operationId: associateNFC
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - tag_id
                - association_type
              properties:
                tag_id:
                  type: string
                  description: "NFC tag unique identifier"
                association_type:
                  type: string
                  enum: [playlist, webhook]
                  description: "Type of association to create"
                client_op_id:
                  type: string
                  description: "Optional client operation ID for tracking"

                # Playlist fields (required if association_type=playlist)
                playlist_id:
                  type: string
                  description: "Playlist ID (required for playlist associations)"

                # Webhook fields (required if association_type=webhook)
                webhook_url:
                  type: string
                  format: uri
                  description: "Webhook URL (required for webhook associations)"
                webhook_method:
                  type: string
                  enum: [GET, POST, PUT]
                  default: POST
                webhook_headers:
                  type: object
                  additionalProperties:
                    type: string
                webhook_body:
                  type: string
                webhook_timeout_ms:
                  type: integer
                  minimum: 1000
                  maximum: 30000
                  default: 5000

            examples:
              playlistAssociation:
                summary: Playlist Association
                value:
                  tag_id: "04:A3:2C:1A:5D:6E:80"
                  association_type: "playlist"
                  playlist_id: "playlist-123"
                  client_op_id: "op-uuid-1234"

              webhookAssociation:
                summary: Webhook Association
                value:
                  tag_id: "04:A3:2C:1A:5D:6E:80"
                  association_type: "webhook"
                  webhook_url: "https://api.example.com/webhook"
                  webhook_method: "POST"
                  webhook_headers:
                    Authorization: "Bearer token123"
                  webhook_body: '{"tag_id": "{{tag_id}}", "timestamp": "{{timestamp}}"}'
                  webhook_timeout_ms: 5000
                  client_op_id: "op-uuid-5678"

      responses:
        '200':
          description: Association created successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          association:
                            $ref: '#/components/schemas/NFCAssociation'

        '400':
          description: Invalid request (validation errors)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnifiedResponse'

        '404':
          description: Playlist not found (for playlist associations)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnifiedResponse'

  /api/nfc/associate/{tag_id}:
    delete:
      tags: [NFC]
      summary: Remove NFC tag association
      operationId: removeNFCAssociation
      parameters:
        - name: tag_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                client_op_id:
                  type: string
      responses:
        '200':
          description: Association removed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnifiedResponse'

  /api/nfc/webhook/test:
    post:
      tags: [NFC]
      summary: Test webhook configuration
      description: |
        Validates webhook URL and sends a test request to verify connectivity.

        This endpoint does not create an association, it only tests the webhook.
        Use this before creating a webhook association to ensure it works.
      operationId: testWebhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - webhook_url
              properties:
                webhook_url:
                  type: string
                  format: uri
                webhook_method:
                  type: string
                  enum: [GET, POST, PUT]
                  default: POST
                webhook_headers:
                  type: object
                  additionalProperties:
                    type: string
                webhook_body:
                  type: string
                webhook_timeout_ms:
                  type: integer
                  minimum: 1000
                  maximum: 30000
                  default: 5000

            example:
              webhook_url: "https://webhook.site/unique-id"
              webhook_method: "POST"
              webhook_headers:
                Content-Type: "application/json"
              webhook_body: '{"test": true}'
              webhook_timeout_ms: 5000

      responses:
        '200':
          description: Webhook test result
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - success
                          - response_time_ms
                        properties:
                          success:
                            type: boolean
                            description: "True if webhook responded with 2xx status"
                          status_code:
                            type: integer
                            nullable: true
                            description: "HTTP status code from webhook (null if connection failed)"
                          response_time_ms:
                            type: integer
                            description: "Time taken for request in milliseconds"
                          error:
                            type: string
                            nullable: true
                            description: "Error message if test failed"

              examples:
                success:
                  summary: Successful Test
                  value:
                    status: success
                    message: "Webhook test successful"
                    data:
                      success: true
                      status_code: 200
                      response_time_ms: 234
                      error: null
                    timestamp: 1706356800

                failure:
                  summary: Failed Test
                  value:
                    status: success
                    message: "Webhook test completed"
                    data:
                      success: false
                      status_code: null
                      response_time_ms: 5000
                      error: "Connection timeout"
                    timestamp: 1706356800

        '400':
          description: Invalid webhook configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnifiedResponse'

  /api/nfc/status:
    get:
      tags: [NFC]
      summary: Get NFC reader status
      operationId: getNFCStatus
      responses:
        '200':
          description: NFC reader status
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - reader_available
                          - scanning
                          - association_active
                          - active_sessions
                        properties:
                          reader_available:
                            type: boolean
                          scanning:
                            type: boolean
                          association_active:
                            type: boolean
                          current_session_id:
                            type: string
                            nullable: true
                          active_sessions:
                            type: array
                            items:
                              type: string

  /api/nfc/scan:
    post:
      tags: [NFC]
      summary: Initiate NFC tag scan
      operationId: scanNFC
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                timeout:
                  type: integer
                  description: Scan timeout in seconds
                  default: 30
                client_op_id:
                  type: string
      responses:
        '200':
          description: NFC scan initiated
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          scanning:
                            type: boolean
                          session_id:
                            type: string

  /api/system/info:
    get:
      tags: [System]
      summary: Get system information
      operationId: getSystemInfo
      responses:
        '200':
          description: System information
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        required:
                          - system_info
                          - version
                          - hostname
                          - uptime
                        properties:
                          system_info:
                            $ref: '#/components/schemas/SystemInfo'
                          version:
                            type: string
                          hostname:
                            type: string
                          uptime:
                            type: number

  /api/system/logs:
    get:
      tags: [System]
      summary: Get system logs
      operationId: getSystemLogs
      parameters:
        - name: lines
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
          description: Number of log lines to return
        - name: level
          in: query
          schema:
            type: string
            enum: [debug, info, warning, error]
          description: Filter by log level
      responses:
        '200':
          description: System logs
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          logs:
                            type: array
                            items:
                              type: string

  /api/system/restart:
    post:
      tags: [System]
      summary: Restart the system
      operationId: restartSystem
      x-skip-in-validation: true
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                client_op_id:
                  type: string
      responses:
        '200':
          description: Restart initiated
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          restarting:
                            type: boolean

  /api/youtube/download:
    post:
      tags: [YouTube]
      summary: Download audio from YouTube URL
      operationId: downloadYouTube
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - url
                - playlist_id
              properties:
                url:
                  type: string
                  format: uri
                playlist_id:
                  type: string
                quality:
                  type: string
                client_op_id:
                  type: string
      responses:
        '200':
          description: Download task initiated
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          task_id:
                            type: string
                          status:
                            type: string

  /api/youtube/search:
    get:
      tags: [YouTube]
      summary: Search YouTube videos
      operationId: searchYouTube
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
          description: Search query
        - name: max_results
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
          description: Maximum number of results
      responses:
        '200':
          description: YouTube search results
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          results:
                            type: array
                            items:
                              $ref: '#/components/schemas/YouTubeSearchResult'

  /api/youtube/status/{task_id}:
    get:
      tags: [YouTube]
      summary: Get YouTube download task status
      operationId: getYouTubeDownloadStatus
      parameters:
        - name: task_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Download task status
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/UnifiedResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/YouTubeDownloadStatus'
